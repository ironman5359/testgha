name: Production 🚀
on:
  push:
    branches:
      - main

jobs:
  branch_restriction:
    name: 🚦 Branch Restriction 🚦
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'icecream' }}
    outputs:
        skip: ${{ steps.check_commit_eligibility.outputs.skip }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          no-tags: true
          refspec: +refs/heads/*:refs/remotes/origin/*
          token: ${{ secrets.CONFLICT_AUTORESOLVE }}
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}
          
      - name: Download Restricted File
        run: |
          aws s3 cp "s3://${{ env.ENVIRONMENT }}-migrations/24Hour/restricted.txt" restricted.txt    
          
      - name: Determine SHA to Add
        id: sha_to_add
        run: |
          parent_count=$(git rev-list --parents -n 1 HEAD | wc -w)
          if [ "$parent_count" -le 2 ]; then
            echo "SHA_TO_ADD=DIRECT_TO_MAIN" >> $GITHUB_ENV
          else
            SHA_TO_ADD=$(git rev-parse HEAD^2 2>/dev/null)
            echo "SHA_TO_ADD=${SHA_TO_ADD}" >> $GITHUB_ENV
            commit_timestamp=$(git show -s --format=%ct "$SHA_TO_ADD")
            current_timestamp=$(date +%s)
            echo "AGE_IN_SECONDS=$((current_timestamp - commit_timestamp))" >> $GITHUB_ENV
          fi
          
      - name: Check and Update Restricted File
        id: check_update
        run: |
          if [[ "$SHA_TO_ADD" == "DIRECT_TO_MAIN" ]]; then
            echo "✅ The branch was merged directly into main branch. Skipping the workflow."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            if grep -q "${SHA_TO_ADD}" restricted.txt; then
              if ((AGE_IN_SECONDS > ${{ env.TIMEFRAME }})); then
                echo "❌ Error: The branch commit $SHA_TO_ADD has already been run before and it's over the ${{ env.TIMEFRAME }} limit."
                echo "skip=true" >> $GITHUB_OUTPUT
              else
                echo "ℹ️ Info: The branch commit $SHA_TO_ADD is within the last ${{ env.TIMEFRAME }} seconds. Proceeding with the workflow."
                echo "skip=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "ℹ️ Info: The branch commit $SHA_TO_ADD has never been run before. Updating SHA file and proceeding with the workflow."
              echo "$SHA_TO_ADD" >> restricted.txt
              aws s3 cp restricted.txt "s3://${{ env.ENVIRONMENT }}-migrations/24Hour/restricted.txt"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          fi
        env:
          SHA_TO_ADD: ${{ env.SHA_TO_ADD }}
          AGE_IN_SECONDS: ${{ env.AGE_IN_SECONDS }}
      # - name: Check commit eligibility
      #   id: check_commit_eligibility
      #   env:
      #     ENVIRONMENT: "icecream"
      #     TIMEFRAME: 120
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_DEFAULT_REGION: us-east-1
      #   shell: bash 
      #   run: |
      #     chmod +x ./lib/branchcheck.sh && ./lib/branchcheck.sh 
  
  migration:
    name: 🏎💨 Production Migration 🏎💨
    environment: production
    runs-on: ubuntu-latest
    needs: branch_restriction
    env:
      GIST_ID: ${{ secrets.GIST_ID }}
    steps:
      - name: Set ENVIRONMENT to production
        run: echo "ENVIRONMENT=production" >> $GITHUB_ENV
        
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CONFLICT_AUTORESOLVE }}
          
      - name: Showtime!
        id: showtime
        if: ${{ needs.check_commit_eligibility.outputs.skip != 'false' }}
        run: |
          echo "🚀 Running the migration script..."